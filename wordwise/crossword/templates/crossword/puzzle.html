{% load static %}

{% block content %}
<div class="container mx-auto px-8 py-8">
    <h1 class="text-2xl font-bold mb-4 text-center">Welcome to Crossword Game</h1>

    <div class="game-box">
        <!-- กริด crossword -->
        <div class="crossword-grid" id="crosswordGrid"></div>

        <!-- ตารางคำใบ้ -->
        <div class="hint-container">
            <h2 class="text-2xl font-bold mb-4" id="title-hint">Hint Table</h2>
            <div class="hint-table" id="hintTable">
                {% for word in words %}
                    <div class="hint-item" data-word="{{ word.word }}">
                        <strong>{{ forloop.counter }}.</strong> {{ word.meaning }}
                    </div>
                    <div class="answer" data-words="{{ word.word }}">
                        {{ word.word }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <button id="checkButton" class="mt-4 px-4 py-2 bg-blue-500 text-white">Check</button>
</div>

<style>
    .game-box {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .crossword-grid {
        display: grid;
        grid-template-columns: repeat(15, 30px);
        grid-template-rows: repeat(15, 30px);
        gap: 1px;
        background-color: #000;
        padding: 1px;
        border: 2px solid green;
    }

    .grid-cell {
        width: 30px;
        height: 30px;
        background-color: #fff;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .grid-cell input {
        width: 100%;
        height: 100%;
        border: none;
        text-align: center;
        font-size: 16px;
        text-transform: uppercase;
        background: transparent;
        outline: none;
    }

    .grid-cell input:focus {
        background-color: #e6f3ff;
    }

    .hint-container {
        width: 400px;
        margin-left: 40px;
    }

    .hint-table {
        background: wheat;
        width: 400px;
        height: 400px;
        overflow-y: auto;
    }

    .hint-item {
        color: black;
        text-align: left;
        padding: 20px;
        font-size: 18px;
    }

    #title-hint {
        text-align: center;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gridSize = 15;
        const grid = document.getElementById('crosswordGrid');
    
        let cells = {}; // เก็บเซลล์ทั้งหมด
        let usedPositions = new Set(); // ตรวจสอบตำแหน่งที่ถูกใช้แล้ว
    
        // สร้างตาราง crossword ขนาด 15x15
        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.x = j;
                cell.dataset.y = i;
    
                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.pattern = "[A-Za-z]";
                input.title = "Only English letters allowed";
                input.addEventListener('input', function(e) {
                    if (!/^[a-zA-Z]$/.test(e.target.value)) {
                        e.target.value = "";
                    }
                });
    
                cell.appendChild(input);
                grid.appendChild(cell);
                cells[`${i},${j}`] = cell;
            }
        }
    
        // ดึงข้อมูล words จาก Django template
        const words = [];
        document.querySelectorAll('.answer').forEach(ans => {
            words.push(ans.dataset.words);
        });
    
        // ฟังก์ชันตรวจสอบว่าคำสามารถใส่ได้โดยไม่มีการชนกันที่ผิดกฎ
        function isValidPlacement(row, col, word, direction) {
            if (direction === 'horizontal') {
                if (col + word.length > gridSize) return false; // ไม่ให้เกินขอบขวา
            } else {
                if (row + word.length > gridSize) return false; // ไม่ให้เกินขอบล่าง
            }
    
            for (let i = 0; i < word.length; i++) {
                let newRow = row + (direction === 'vertical' ? i : 0);
                let newCol = col + (direction === 'horizontal' ? i : 0);
                let key = `${newRow},${newCol}`;
    
                if (usedPositions.has(key)) {
                    // ถ้ามีตัวอักษรอยู่ก่อนแล้ว ต้องตรงกัน
                    let existingLetter = cells[key].firstChild.value;
                    if (existingLetter && existingLetter !== word[i].toUpperCase()) {
                        return false; // มีตัวอักษรอยู่แล้วแต่ไม่ตรงกัน
                    }
                }
            }
    
            return true;
        }
    
        // ฟังก์ชันสุ่มตำแหน่งที่มีพื้นที่เพียงพอ
        function getValidPosition(word) {
            let row, col, direction;
            let attempts = 0;
            const maxAttempts = 100; // ป้องกันลูปไม่สิ้นสุด
    
            do {
                row = Math.floor(Math.random() * gridSize);
                col = Math.floor(Math.random() * gridSize);
                direction = Math.random() > 0.5 ? 'horizontal' : 'vertical'; // สุ่มแนว
                attempts++;
                if (attempts > maxAttempts) return null; // หยุดถ้าหาที่วางไม่ได้
            } while (!isValidPlacement(row, col, word, direction));
    
            return { row, col, direction };
        }
    
        // วางคำลงในกริด และใส่หมายเลขกำกับ
        words.forEach((word, index) => {
            let position = getValidPosition(word);
            if (!position) return; // ถ้าวางไม่ได้ ข้ามไปเลย
    
            let { row, col, direction } = position;
    
            for (let i = 0; i < word.length; i++) {
                let newRow = row + (direction === 'vertical' ? i : 0);
                let newCol = col + (direction === 'horizontal' ? i : 0);
                let key = `${newRow},${newCol}`;
                let cell = cells[key];
    
                if (cell) {
                    cell.firstChild.value = word[i].toUpperCase();
                    cell.firstChild.readOnly = true;
                    usedPositions.add(key);
                }
            }
    
            // ใส่หมายเลขกำกับที่ช่องแรกของคำ
            let startCell = cells[`${row},${col}`];
            if (startCell) {
                const label = document.createElement('div');
                label.innerText = index + 1;
                label.style.position = 'absolute';
                label.style.fontSize = '10px';
                label.style.color = 'black';
                label.style.top = '2px';
                label.style.left = '2px';
    
                startCell.style.position = 'relative';
                startCell.appendChild(label);
            }
        });
    });
    </script>
    
{% endblock %}
